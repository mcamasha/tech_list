name: Weekly Data Update

on:
  schedule:
    - cron: "0 0 * * 1" # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 00:00 UTC
  workflow_dispatch: # –†–∞–∑—Ä–µ—à–∞–µ—Ç —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write # –î–∞—ë—Ç –ø—Ä–∞–≤–æ –Ω–∞ git push

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install axios

      - name: Run update script
        id: run_script
        run: node scripts/update_data.js

      - name: Commit and push changes
        id: commit_push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add --all
          if ! git diff --staged --quiet; then
            git commit -m "Auto-update data: $(date +'%Y-%m-%d')"
            git pull --rebase origin main
            git push origin main
            echo "status=success" >> $GITHUB_OUTPUT
            echo "changes=committed" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "changes=no_changes" >> $GITHUB_OUTPUT
          fi

    # –û—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    notify:
      needs: [update-data]
      runs-on: ubuntu-latest
      if: always()  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ update-data
      
      steps:
        - name: Send notification to Telegram
          env:
            TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
            TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          run: |
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ job
            if [[ "${{ needs.update-data.result }}" == "success" ]]; then
              STATUS_EMOJI="‚úÖ"
              STATUS_TEXT="–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω"
              COLOR_CODE="2F8B5A"  # –∑–µ–ª—ë–Ω—ã–π
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
              if [[ "${{ needs.update-data.outputs.commit_push.changes }}" == "committed" ]]; then
                DETAILS="–§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
              else
                DETAILS="–î–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –±—ã–ª–æ"
              fi
            elif [[ "${{ needs.update-data.result }}" == "failure" ]]; then
              STATUS_EMOJI="‚ùå"
              STATUS_TEXT="–û—à–∏–±–∫–∞"
              COLOR_CODE="DC2626"  # –∫—Ä–∞—Å–Ω—ã–π
              DETAILS="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ action"
            elif [[ "${{ needs.update-data.result }}" == "cancelled" ]]; then
              STATUS_EMOJI="‚ö†Ô∏è"
              STATUS_TEXT="–û—Ç–º–µ–Ω—ë–Ω"
              COLOR_CODE="F59E0B"  # –∂—ë–ª—Ç—ã–π
              DETAILS="–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–º–µ–Ω–µ–Ω–æ"
            else
              STATUS_EMOJI="‚ö†Ô∏è"
              STATUS_TEXT="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å"
              COLOR_CODE="6B7280"  # —Å–µ—Ä—ã–π
              DETAILS="–°—Ç–∞—Ç—É—Å: ${{ needs.update-data.result }}"
            fi
            
            MESSAGE="$STATUS_EMOJI GitHub Action –∑–∞–≤–µ—Ä—à—ë–Ω
            
            üìÖ –í—Ä–µ–º—è: $(date +'%Y-%m-%d %H:%M:%S UTC')
            üè∑Ô∏è –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
            üè∑Ô∏è –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            üë§ –ó–∞–ø—É—Å–∫: ${{ github.actor }}
            
            üìä –°—Ç–∞—Ç—É—Å: $STATUS_TEXT
            üìù –î–µ—Ç–∞–ª–∏: $DETAILS
            üîó –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è JSON
            ESCAPED_MESSAGE=$(printf '%s\n' "$MESSAGE" | sed 's/"/\\"/g')
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
            RESPONSE=$(curl -s -X POST \
              "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TELEGRAM_CHAT_ID&text=$ESCAPED_MESSAGE&parse_mode=MarkdownV2")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏
            if echo "$RESPONSE" | jq -e '.ok' >/dev/null 2>&1; then
              echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
            else
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram"
              echo "Response: $RESPONSE"
            fi