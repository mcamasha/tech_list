name: Weekly Data Update

on:
  schedule:
    - cron: "0 0 * * 1" # –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 00:00 UTC
  workflow_dispatch: # –†–∞–∑—Ä–µ—à–∞–µ—Ç —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update-
    runs-on: ubuntu-latest
    permissions:
      contents: write # –î–∞—ë—Ç –ø—Ä–∞–≤–æ –Ω–∞ git push

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install axios

      - name: Run update script
        id: run_script
        run: node scripts/update_data.js

      - name: Commit and push changes
        id: commit_push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add --all
          if ! git diff --staged --quiet; then
            git commit -m "Auto-update data: $(date +'%Y-%m-%d')"
            git pull --rebase origin main
            git push origin main
            echo "status=success" >> $GITHUB_OUTPUT
            echo "changes=committed" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "changes=no_changes" >> $GITHUB_OUTPUT
          fi

      - name: Send notification to Telegram
        if: always()  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          if [[ "${{ job.status }}" == "success" ]]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω"
            DETAILS="Action —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if [[ "${{ steps.commit_push.outputs.changes }}" == "committed" ]]; then
              DETAILS="$DETAILS - —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
            else
              DETAILS="$DETAILS - –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –±—ã–ª–æ"
            fi
          elif [[ "${{ job.status }}" == "failure" ]]; then
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="–û—à–∏–±–∫–∞"
            DETAILS="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ action"
          elif [[ "${{ job.status }}" == "cancelled" ]]; then
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="–û—Ç–º–µ–Ω—ë–Ω"
            DETAILS="–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–º–µ–Ω–µ–Ω–æ"
          else
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å"
            DETAILS="–°—Ç–∞—Ç—É—Å: ${{ job.status }}"
          fi
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML parse mode, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤
          MESSAGE="$STATUS_EMOJI GitHub Action –∑–∞–≤–µ—Ä—à—ë–Ω

          üìÖ –í—Ä–µ–º—è: $(date +'%Y-%m-%d %H:%M:%S UTC')
          üè∑Ô∏è –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          üè∑Ô∏è –í–µ—Ç–∫–∞: ${{ github.ref_name }}
          üë§ –ó–∞–ø—É—Å–∫: ${{ github.actor }}

          üìä –°—Ç–∞—Ç—É—Å: $STATUS_TEXT
          üìù –î–µ—Ç–∞–ª–∏: $DETAILS
          üîó –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ & < > –¥–ª—è HTML
          ESCAPED_MESSAGE=$(printf '%s\n' "$MESSAGE" | sed 's/&/\&amp;/g' | sed 's/</\&lt;/g' | sed 's/>/\&gt;/g')
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram —Å HTML parse mode
          RESPONSE=$(curl -s -X POST \
            "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID&text=$ESCAPED_MESSAGE&parse_mode=HTML")
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏
          if echo "$RESPONSE" | jq -e '.ok' >/dev/null 2>&1; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram"
            echo "Response: $RESPONSE"
          fi